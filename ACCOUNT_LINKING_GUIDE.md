# ุฏููู ุฑุจุท ุงูุญุณุงุจุงุช - Account Linking Guide

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฏุนู ุงููุธุงู ุฑุจุท ุงูุญุณุงุจุงุช ุจูู ุทุฑู ุงููุตุงุฏูุฉ ุงููุฎุชููุฉุ ููุง ูุนูู ุฃู ุงููุณุชุฎุฏู ููููู ุงุณุชุฎุฏุงู ููุณ ุงูุฅูููู ูุน:
- ุชุณุฌูู ุงูุฏุฎูู ุนุจุฑ Google OAuth
- ุชุณุฌูู ุงูุฏุฎูู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููููุฉ ุงููุฑูุฑ

## ๐ ุงูุณููุงุฑูููุงุช ุงููุฏุนููุฉ

### ุงูุณููุงุฑูู 1: Google ุฃููุงูุ ุซู ุฅุถุงูุฉ ูููุฉ ูุฑูุฑ
```
1. ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ุนุจุฑ Google ุจุงูุฅูููู: user@example.com
   โ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ ูุน google_id ููุท (ุจุฏูู password_hash)

2. ูุงุญูุงู ูุญุงูู ุงูุชุณุฌูู ุจููุณ ุงูุฅูููู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
   โ ุงููุธุงู ูุฑุจุท ูููุฉ ุงููุฑูุฑ ุจุงูุญุณุงุจ ุงูููุฌูุฏ
   โ ูุตุจุญ ุงูุญุณุงุจ ูุฏุนู ููุง ุงูุทุฑููุชูู
```

### ุงูุณููุงุฑูู 2: ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃููุงูุ ุซู Google
```
1. ุงููุณุชุฎุฏู ูุณุฌู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: user@example.com
   โ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ ูุน password_hash ููุท (ุจุฏูู google_id)

2. ูุงุญูุงู ูุณุฌู ุฏุฎูู ุนุจุฑ Google ุจููุณ ุงูุฅูููู
   โ ุงููุธุงู ูุฑุจุท Google ID ุจุงูุญุณุงุจ ุงูููุฌูุฏ
   โ ูุตุจุญ ุงูุญุณุงุจ ูุฏุนู ููุง ุงูุทุฑููุชูู
```

### ุงูุณููุงุฑูู 3: ูุญุงููุฉ ุชุณุฌูู ููุฑุฑ
```
1. ุงููุณุชุฎุฏู ูุฏูู ุญุณุงุจ ูุน ูููุฉ ูุฑูุฑ
2. ูุญุงูู ุงูุชุณุฌูู ูุฑุฉ ุฃุฎุฑู ุจููุณ ุงูุฅูููู
   โ ุฑุณุงูุฉ ุฎุทุฃ: "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุฎุฏู ุจุงููุนู"
```

## ๐ ุขููุฉ ุงูุนูู ุงูุชูููุฉ

### 1. ูู ุชุณุฌูู ุงูุฏุฎูู ุนุจุฑ Google (`/api/auth/google`)

```typescript
// ุงูุจุญุซ ุนู ุงููุณุชุฎุฏู ุนุจุฑ Google ID
let user = await getUserByGoogleId(googleId)

if (!user) {
  // ุงูุจุญุซ ุนู ุงููุณุชุฎุฏู ุจุงูุฅูููู
  user = await getUserByEmail(email)
  
  if (user) {
    // ุฑุจุท Google ID ุจุงูุญุณุงุจ ุงูููุฌูุฏ
    user = await updateUserGoogleId(user.id, googleId)
  } else {
    // ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
    user = await createUser({
      email,
      name,
      googleId,
      avatarUrl: picture,
    })
  }
}
```

### 2. ูู ุงูุชุณุฌูู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (`/api/auth/register`)

```typescript
// ุงูุจุญุซ ุนู ุงููุณุชุฎุฏู ุจุงูุฅูููู
const existingUser = await getUserByEmail(email)

if (existingUser) {
  // ุฅุฐุง ูุงู ุงูุญุณุงุจ ููุฌูุฏ ุจุฏูู ูููุฉ ูุฑูุฑ (Google ููุท)
  if (!existingUser.password_hash) {
    // ุฅุถุงูุฉ ูููุฉ ุงููุฑูุฑ ููุญุณุงุจ ุงูููุฌูุฏ
    await updateUserPassword(existingUser.id, passwordHash)
    // ุชุณุฌูู ุฏุฎูู ุชููุงุฆู
  } else {
    // ุงูุญุณุงุจ ููุฌูุฏ ูุน ูููุฉ ูุฑูุฑุ ุฑูุถ ุงูุชุณุฌูู
    return error("ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุฎุฏู ุจุงููุนู")
  }
} else {
  // ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
  await createUser({ email, passwordHash, name })
}
```

### 3. ูู ุชุณุฌูู ุงูุฏุฎูู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (`/api/auth/login`)

```typescript
const user = await getUserByEmail(email)

if (!user) {
  return error("ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ")
}

// ุฅุฐุง ูุงู ุงูุญุณุงุจ ูุฑุชุจุท ุจู Google ููุท
if (!user.password_hash) {
  return error("ูุฐุง ุงูุญุณุงุจ ูุฑุชุจุท ุจุญุณุงุจ Google ููุท. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุนุจุฑ Google ุฃู ุฅุถุงูุฉ ูููุฉ ูุฑูุฑ ูู ุตูุญุฉ ุงูุชุณุฌูู")
}

// ุงูุชุญูู ูู ูููุฉ ุงููุฑูุฑ
const isValid = await verifyPassword(password, user.password_hash)
```

## ๐๏ธ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุฌุฏูู `users`
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255), -- NULL ููุญุณุงุจุงุช ุงููุฑุชุจุทุฉ ุจู Google ููุท
  name VARCHAR(255),
  google_id VARCHAR(255) UNIQUE, -- NULL ููุญุณุงุจุงุช ุงููุฑุชุจุทุฉ ุจุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุท
  avatar_url TEXT,
  email_verified BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  last_login TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### ุญุงูุงุช ุงูุญุณุงุจ ุงููุฎุชููุฉ

| ุงูุญุงูุฉ | password_hash | google_id | ุงููุตู |
|--------|---------------|-----------|--------|
| Email Only | โ | โ | ุญุณุงุจ ูุฑุชุจุท ุจุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุท |
| Google Only | โ | โ | ุญุณุงุจ ูุฑุชุจุท ุจู Google ููุท |
| Linked | โ | โ | ุญุณุงุจ ูุฑุชุจุท ุจููุง ุงูุทุฑููุชูู |
| Invalid | โ | โ | ุญุงูุฉ ุบูุฑ ุตุญูุญุฉ (ูุง ูุฌุจ ุฃู ุชุญุฏุซ) |

## ๐ฏ ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

### ูููุณุชุฎุฏู ุงูุฌุฏูุฏ
1. **ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุชุณุฌูู**: Google ุฃู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
2. **ุฅูุดุงุก ุงูุญุณุงุจ**: ูุชู ุฅูุดุงุก ุญุณุงุจ ุจุงูุทุฑููุฉ ุงููุฎุชุงุฑุฉ
3. **ุฅุถุงูุฉ ุทุฑููุฉ ุฃุฎุฑู ูุงุญูุงู**: ูููู ุฑุจุท ุทุฑููุฉ ุฃุฎุฑู ุจููุณ ุงูุฅูููู

### ูููุณุชุฎุฏู ุงูููุฌูุฏ
1. **ุชุณุฌูู ุงูุฏุฎูู ุจุงูุทุฑููุฉ ุงูุฃุตููุฉ**: ูุนูู ุจุดูู ุทุจูุนู
2. **ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู ุจุทุฑููุฉ ุฃุฎุฑู**: 
   - ุฅุฐุง ูุงู ุงูุญุณุงุจ ูุฑุชุจุท: ูุนูู ุจุดูู ุทุจูุนู
   - ุฅุฐุง ูู ููู ูุฑุชุจุท: ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ

## ๐ ุงูุฃูุงู

### ุญูุงูุฉ ูู ุงูุชุถุงุฑุจ
- **ุฅูููู ูุฑูุฏ**: ูู ุฅูููู ูููู ุฃู ูููู ูุฑุชุจุท ุจุญุณุงุจ ูุงุญุฏ ููุท
- **Google ID ูุฑูุฏ**: ูู Google ID ูููู ุฃู ูููู ูุฑุชุจุท ุจุญุณุงุจ ูุงุญุฏ ููุท
- **ุฑุจุท ุขูู**: ูุชู ุฑุจุท ุงูุญุณุงุจุงุช ููุท ุนูุฏ ุงูุชุฃูุฏ ูู ููุณ ุงูุฅูููู

### ุฑุณุงุฆู ุงูุฎุทุฃ ุงููุงุถุญุฉ
- **"ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุฎุฏู ุจุงููุนู"**: ุนูุฏ ูุญุงููุฉ ุงูุชุณุฌูู ุงูููุฑุฑ
- **"ูุฐุง ุงูุญุณุงุจ ูุฑุชุจุท ุจุญุณุงุจ Google ููุท"**: ุนูุฏ ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู ุจูููุฉ ูุฑูุฑ ูุญุณุงุจ Google ููุท
- **"ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ"**: ุนูุฏ ูุดู ุงูุชุญูู ูู ุงูุจูุงูุงุช

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### ุงุฎุชุจุงุฑ ุฑุจุท ุงูุญุณุงุจุงุช
1. **ุฅูุดุงุก ุญุณุงุจ ุนุจุฑ Google**
2. **ูุญุงููุฉ ุงูุชุณุฌูู ุจููุณ ุงูุฅูููู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู**
3. **ุงูุชุญูู ูู ุฃู ุงูุญุณุงุจ ุฃุตุจุญ ูุฏุนู ููุง ุงูุทุฑููุชูู**

### ุงุฎุชุจุงุฑ ุฑุณุงุฆู ุงูุฎุทุฃ
1. **ูุญุงููุฉ ุงูุชุณุฌูู ุงูููุฑุฑ**
2. **ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู ุจุทุฑููุฉ ุฎุงุทุฆุฉ**
3. **ุงูุชุญูู ูู ูุถูุญ ุงูุฑุณุงุฆู**

## ๐ ูุฑุงูุจุฉ ุงููุธุงู

### ุฅุญุตุงุฆูุงุช ูููุฏุฉ
```sql
-- ุนุฏุฏ ุงูุญุณุงุจุงุช ุงููุฑุชุจุทุฉ
SELECT 
  COUNT(*) as total_users,
  COUNT(password_hash) as email_linked,
  COUNT(google_id) as google_linked,
  COUNT(CASE WHEN password_hash IS NOT NULL AND google_id IS NOT NULL THEN 1 END) as fully_linked
FROM users;

-- ุขุฎุฑ ุชุณุฌูู ุฏุฎูู ููู ููุน
SELECT 
  'Email Login' as login_type,
  COUNT(*) as count
FROM users 
WHERE last_login IS NOT NULL AND password_hash IS NOT NULL
UNION ALL
SELECT 
  'Google Login' as login_type,
  COUNT(*) as count
FROM users 
WHERE last_login IS NOT NULL AND google_id IS NOT NULL;
```

---

ูุฐุง ุงููุธุงู ูููุฑ ูุฑููุฉ ูุงููุฉ ูููุณุชุฎุฏููู ูุน ุงูุญูุงุธ ุนูู ุงูุฃูุงู ูุงููุถูุญ! ๐